<!DOCTYPE html>
<html>
<head>
    <title>Test Save API</title>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 800px; margin: 0 auto; }
        button { padding: 12px 24px; margin: 10px; font-size: 16px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 4px; }
        button:hover { background: #45a049; }
        #output { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 4px; white-space: pre-wrap; font-family: monospace; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test Save Recipe API</h1>
    <p>Click the button to test saving a recipe:</p>
    
    <button onclick="testSave()">ğŸ’¾ Test Save Recipe</button>
    <button onclick="clearOutput()">ğŸ—‘ï¸ Clear Output</button>
    
    <div id="output"></div>
    
    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
        }
        
        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }
        
        async function testSave() {
            log('ğŸ”µ Starting test...', 'info');
            
            const testRecipe = {
                title: 'Test Recipe ' + Date.now(),
                cuisine: 'italian',
                ingredients: '1 cup flour\n2 eggs\n1 tbsp salt',
                steps: 'Step 1: Mix ingredients\nStep 2: Cook\nStep 3: Serve'
            };
            
            log('ğŸ“¤ Sending: ' + JSON.stringify(testRecipe, null, 2));
            
            try {
                const response = await fetch('api/save_ai_recipe.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(testRecipe)
                });
                
                log(`ğŸ“¡ HTTP Status: ${response.status} ${response.statusText}`);
                log(`ğŸ“‹ Content-Type: ${response.headers.get('Content-Type')}`);
                
                // Get response as text first to see what we're getting
                const responseText = await response.text();
                log(`ğŸ“¥ Raw Response (${responseText.length} bytes):\n${responseText.substring(0, 500)}`);
                
                // Try to parse as JSON
                try {
                    const data = JSON.parse(responseText);
                    log('âœ… Valid JSON received!', 'success');
                    log('ğŸ“¦ Parsed Data:\n' + JSON.stringify(data, null, 2));
                    
                    if (data.success) {
                        log('ğŸ‰ SUCCESS! Recipe saved!', 'success');
                        
                        if (data.mode === 'local') {
                            log('ğŸ’¾ Mode: LOCAL STORAGE');
                            log(`ğŸ“ Recipe ID: ${data.recipe_id}`);
                            
                            // Save to localStorage
                            const localRecipes = JSON.parse(localStorage.getItem('local_recipes') || '[]');
                            localRecipes.push({
                                id: data.recipe_id,
                                ...data.recipe
                            });
                            localStorage.setItem('local_recipes', JSON.stringify(localRecipes));
                            
                            log(`âœ… Saved to localStorage! Total recipes: ${localRecipes.length}`, 'success');
                        } else {
                            log('ğŸ’¾ Mode: DATABASE');
                            log(`ğŸ“ Recipe ID: ${data.recipe_id}`);
                        }
                    } else {
                        log('âŒ API returned error: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (jsonError) {
                    log('âŒ JSON Parse Error: ' + jsonError.message, 'error');
                    log('Raw response was: ' + responseText.substring(0, 200), 'error');
                }
                
            } catch (error) {
                log('âŒ Fetch Error: ' + error.message, 'error');
                console.error('Full error:', error);
            }
        }
        
        // Initial log
        log('ğŸŸ¢ Test page loaded. Ready to test!', 'success');
    </script>
</body>
</html>

